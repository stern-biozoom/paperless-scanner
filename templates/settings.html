<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Settings - Paperless Scanner</title>
<style>
body { 
  font-family: sans-serif; 
  margin: 2rem; 
  background-color: #f5f5f5; 
}
.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  padding: 2rem;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1 { 
  color: #333; 
  margin-bottom: 2rem;
  text-align: center;
}
.form-group {
  margin-bottom: 1.5rem;
}
label {
  display: block;
  font-weight: bold;
  margin-bottom: 0.5rem;
  color: #333;
}
input, select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 1rem;
  box-sizing: border-box;
}
input:focus, select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,.25);
}
button { 
  padding: 1rem 2rem; 
  font-size: 1rem; 
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
  margin-right: 1rem;
  margin-bottom: 1rem;
}
.primary-btn {
  background-color: #007bff;
  color: white;
}
.primary-btn:hover {
  background-color: #0056b3;
}
.secondary-btn {
  background-color: #6c757d;
  color: white;
}
.secondary-btn:hover {
  background-color: #545b62;
}
.danger-btn {
  background-color: #dc3545;
  color: white;
}
.danger-btn:hover {
  background-color: #c82333;
}
.status {
  padding: 0.75rem 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  display: none;
}
.status.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.status.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.nav {
  text-align: center;
  margin-bottom: 2rem;
}
.nav a {
  color: #007bff;
  text-decoration: none;
  margin: 0 1rem;
}
.nav a:hover {
  text-decoration: underline;
}
.help-text {
  font-size: 0.9rem;
  color: #666;
  margin-top: 0.25rem;
}
.tags-input {
  position: relative;
}
.tags-display {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.tag {
  background-color: #e9ecef;
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
}
.tag .remove {
  margin-left: 0.5rem;
  cursor: pointer;
  color: #666;
}
.tag .remove:hover {
  color: #dc3545;
}
.status.info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
  vertical-align: middle;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.switch input:checked + .slider {
  background-color: #007bff;
}
.switch input:checked + .slider:before {
  transform: translateX(24px);
}
</style>
</head>
<body>
<div class="container">
<div class="nav">
  <a href="/">Scanner</a>
  <a href="/settings">Settings</a>
</div>

<h1>‚öôÔ∏è Scanner Settings</h1>

<div id="status" class="status"></div>

<form id="settingsForm">
  <div class="form-group">
    <label for="paperlessApiUrl">Paperless-ngx API URL</label>
    <input type="url" id="paperlessApiUrl" name="paperlessApiUrl" required 
           placeholder="http://192.168.1.100:8000">
    <div class="help-text">The base URL of your Paperless-ngx installation (without /api)</div>
  </div>

  <div class="form-group">
    <label for="paperlessApiToken">API Token</label>
    <input type="password" id="paperlessApiToken" name="paperlessApiToken" required 
           placeholder="Your Paperless-ngx API token">
    <div class="help-text">Get this from your Paperless-ngx profile page</div>
  </div>

  <div class="form-group">
    <label for="scanOutputDir">Scan Output Directory</label>
    <input type="text" id="scanOutputDir" name="scanOutputDir" required 
           placeholder="/tmp">
    <div class="help-text">Temporary directory for storing scanned documents</div>
  </div>

  <div class="form-group">
    <label for="scanResolution">Scan Resolution (DPI)</label>
    <select id="scanResolution" name="scanResolution">
      <option value="150">150 DPI (Fast, smaller files)</option>
      <option value="300">300 DPI (Recommended)</option>
      <option value="600">600 DPI (High quality, larger files)</option>
    </select>
    <div class="help-text">Higher resolution means better quality but larger files</div>
  </div>

  <div class="form-group">
    <label for="scannerDeviceUrl">Scanner Device URL (Optional)</label>
    <input type="text" id="scannerDeviceUrl" name="scannerDeviceUrl" 
           placeholder="e.g., escl:https://192.168.178.188:443">
    <div class="help-text">Leave empty for auto-detection. Format: escl:https://IP:PORT or other SANE device format</div>
  </div>

  <div class="form-group">
    <label for="defaultTags">Default Tags</label>
    <div class="tags-input">
      <input type="text" id="newTag" placeholder="Add a tag and press Enter">
      <div class="help-text">Tags that will be automatically applied to scanned documents</div>
      <div id="tagsDisplay" class="tags-display"></div>
    </div>
  </div>

  <div class="form-group">
    <label for="source">Scan Source</label>
    <div style="display: flex; gap: 0.5rem;">
      <div style="flex: 1;">
        <input type="text" id="source" name="source" placeholder="e.g., ADF, Flatbed">
      </div>
      <button type="button" id="fetchSourcesBtn" class="secondary-btn" style="padding: 0.5rem 1rem; margin: 0; white-space: nowrap;">üîç Fetch from Scanner</button>
    </div>
    <select id="sourceSelect" style="display: none; margin-top: 0.5rem;">
      <option value="">-- Select Source --</option>
    </select>
    <div class="help-text">Leave empty for scanner default (e.g., "ADF", "Flatbed", "Automatic Document Feeder")</div>
  </div>

  <div class="form-group" style="display: flex; gap: 2rem; align-items: flex-start;">
    <div>
      <label for="duplex">Duplex Scan</label>
      <label class="switch">
        <input type="checkbox" id="duplex" name="duplex">
        <span class="slider"></span>
      </label>
      <div class="help-text">Scan both sides of each page</div>
    </div>
    <div style="flex: 1; max-width: 200px;">
      <label for="swskip">Skip Blank Pages (%)</label>
      <input type="number" id="swskip" name="swskip" min="0" max="100" step="0.1" placeholder="0" style="width: 100%;">
      <div class="help-text">Discard pages with fewer dark pixels than this threshold (0 = off)</div>
    </div>
  </div>

  <div class="form-group">
    <label for="pageFormat">Common Page Formats</label>
    <select id="pageFormat">
      <option value="custom">Custom (use manual values below)</option>
      <option value="a4">A4 (210 x 297 mm)</option>
      <option value="a5">A5 (148 x 210 mm)</option>
      <option value="letter">Letter (216 x 279 mm)</option>
      <option value="legal">Legal (216 x 356 mm)</option>
    </select>
  </div>

  <div class="form-group" style="display: flex; gap: 1rem;">
    <div style="flex: 1;">
      <label for="pageWidth">Page Width (mm)</label>
      <input type="number" id="pageWidth" name="pageWidth" min="0" step="1" placeholder="0">
      <div class="help-text">0 for default</div>
    </div>
    <div style="flex: 1;">
      <label for="pageHeight">Page Height (mm)</label>
      <input type="number" id="pageHeight" name="pageHeight" min="0" step="1" placeholder="0">
      <div class="help-text">0 for default</div>
    </div>
  </div>

  <div class="form-group">
    <label for="outputFormat">Output Format</label>
    <select id="outputFormat" name="outputFormat">
      <option value="pdf">PDF</option>
      <option value="tiff">TIFF</option>
      <option value="png">PNG</option>
      <option value="jpeg">JPEG</option>
    </select>
    <div class="help-text">File format for the scanned pages</div>
  </div>

  <div class="form-group">
    <label for="testUpload">Test File Upload</label>
    <input type="file" id="testUpload" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif" style="margin-bottom: 0.5rem;">
    <div class="help-text">Select a document file to test uploading to Paperless-ngx</div>
    <button type="button" id="uploadTestBtn" class="secondary-btn" style="margin-top: 0.5rem;" disabled>üì§ Test Upload</button>
  </div>

  <div class="form-group">
    <button type="submit" class="primary-btn">üíæ Save Settings</button>
    <button type="button" id="testBtn" class="secondary-btn">üîß Test Connection</button>
    <button type="button" id="resetBtn" class="danger-btn">üîÑ Reset to Defaults</button>
  </div>
</form>
</div>

<script>
let currentSettings = {};
let defaultTags = [];

const statusEl = document.getElementById("status");
const form = document.getElementById("settingsForm");
const testBtn = document.getElementById("testBtn");
const resetBtn = document.getElementById("resetBtn");
const newTagInput = document.getElementById("newTag");
const tagsDisplay = document.getElementById("tagsDisplay");
const testUploadInput = document.getElementById("testUpload");
const uploadTestBtn = document.getElementById("uploadTestBtn");
const pageFormatSelect = document.getElementById("pageFormat");
const pageWidthInput = document.getElementById("pageWidth");
const pageHeightInput = document.getElementById("pageHeight");
const fetchSourcesBtn = document.getElementById("fetchSourcesBtn");
const sourceInput = document.getElementById("source");
const sourceSelect = document.getElementById("sourceSelect");

const PAGE_FORMATS = {
  a4: { width: 210, height: 297 },
  a5: { width: 148, height: 210 },
  letter: { width: 216, height: 279 },
  legal: { width: 216, height: 356 }
};

pageFormatSelect.onchange = () => {
  const format = pageFormatSelect.value;
  if (PAGE_FORMATS[format]) {
    pageWidthInput.value = PAGE_FORMATS[format].width;
    pageHeightInput.value = PAGE_FORMATS[format].height;
  }
};

pageWidthInput.oninput = pageHeightInput.oninput = () => {
  pageFormatSelect.value = "custom";
};

fetchSourcesBtn.onclick = async () => {
  try {
    fetchSourcesBtn.disabled = true;
    fetchSourcesBtn.textContent = "‚è≥ Fetching...";
    
    let deviceId = document.getElementById("scannerDeviceUrl").value;
    
    // If no device URL is set, try to detect scanners first
    if (!deviceId) {
      const detectResponse = await fetch("/api/scanners");
      const detectResult = await detectResponse.json();
      if (detectResult.scanners && detectResult.scanners.length > 0) {
        deviceId = detectResult.scanners[0].device;
      }
    }
    
    if (!deviceId) {
      showStatus("No scanner detected. Please enter a Scanner Device URL or ensure a scanner is connected.", "error");
      return;
    }

    const response = await fetch(`/api/scanner-options?deviceId=${encodeURIComponent(deviceId)}`);
    const result = await response.json();
    
    if (response.ok && result.settings && result.settings.sources && result.settings.sources.length > 0) {
      sourceSelect.innerHTML = '<option value="">-- Select Source --</option>';
      result.settings.sources.forEach(src => {
        const option = document.createElement("option");
        option.value = src;
        option.textContent = src;
        sourceSelect.appendChild(option);
      });
      sourceSelect.style.display = "block";
      showStatus(`Found ${result.settings.sources.length} sources for device ${deviceId}`, "success");
    } else if (result.error) {
      showStatus(`Failed to fetch sources: ${result.error}`, "error");
    } else {
      showStatus("No specific sources found for this scanner (using defaults).", "info");
    }
  } catch (error) {
    showStatus(`Error fetching sources: ${error.message}`, "error");
  } finally {
    fetchSourcesBtn.disabled = false;
    fetchSourcesBtn.textContent = "üîç Fetch from Scanner";
  }
};

function isDuplexSource(name) {
  return /duplex/i.test(name);
}

sourceSelect.onchange = () => {
  if (sourceSelect.value) {
    sourceInput.value = sourceSelect.value;
    document.getElementById('duplex').checked = isDuplexSource(sourceSelect.value);
  }
};

function showStatus(message, type = 'success') {
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
  setTimeout(() => {
    statusEl.style.display = 'none';
  }, 5000);
}

function renderTags() {
  tagsDisplay.innerHTML = '';
  defaultTags.forEach((tag, index) => {
    const tagEl = document.createElement('div');
    tagEl.className = 'tag';
    tagEl.innerHTML = `
      ${tag}
      <span class="remove" onclick="removeTag(${index})">‚úï</span>
    `;
    tagsDisplay.appendChild(tagEl);
  });
}

function addTag(tag) {
  tag = tag.trim();
  if (tag && !defaultTags.includes(tag)) {
    defaultTags.push(tag);
    renderTags();
  }
}

function removeTag(index) {
  defaultTags.splice(index, 1);
  renderTags();
}

// Load settings on page load
async function loadSettings() {
  try {
    const response = await fetch("/api/settings");
    if (response.ok) {
      currentSettings = await response.json();
      
      // Populate form
      document.getElementById("paperlessApiUrl").value = currentSettings.paperlessApiUrl || '';
      document.getElementById("paperlessApiToken").value = currentSettings.paperlessApiToken || '';
      document.getElementById("scanOutputDir").value = currentSettings.scanOutputDir || '/tmp';
      document.getElementById("scanResolution").value = currentSettings.scanResolution || 300;
      document.getElementById("scannerDeviceUrl").value = currentSettings.scannerDeviceUrl || '';
      document.getElementById("source").value = currentSettings.source || '';
      document.getElementById("duplex").checked = currentSettings.duplex || isDuplexSource(currentSettings.source || '');
      document.getElementById("swskip").value = currentSettings.swskip || 0;
      document.getElementById("pageWidth").value = currentSettings.pageWidth || 0;
      document.getElementById("pageHeight").value = currentSettings.pageHeight || 0;
      document.getElementById("outputFormat").value = currentSettings.outputFormat || 'pdf';
      
      // Update page format dropdown based on loaded values
      const w = currentSettings.pageWidth;
      const h = currentSettings.pageHeight;
      let matchedFormat = "custom";
      for (const [format, dims] of Object.entries(PAGE_FORMATS)) {
        if (dims.width === w && dims.height === h) {
          matchedFormat = format;
          break;
        }
      }
      pageFormatSelect.value = matchedFormat;
      
      defaultTags = currentSettings.defaultTags || ['scanned', 'automated'];
      renderTags();

      // Trigger source fetching if device URL is present
      if (currentSettings.scannerDeviceUrl) {
        fetchSourcesBtn.click();
      }
    }
  } catch (error) {
    showStatus(`Failed to load settings: ${error.message}`, "error");
  }
}

// Ensure loadSettings is called on page load
window.onload = loadSettings;

// Save settings
form.onsubmit = async (e) => {
  e.preventDefault();
  
  const formData = new FormData(form);
  const settings = {
    paperlessApiUrl: formData.get('paperlessApiUrl'),
    paperlessApiToken: formData.get('paperlessApiToken'),
    scanOutputDir: formData.get('scanOutputDir'),
    scanResolution: parseInt(formData.get('scanResolution')),
    scannerDeviceUrl: formData.get('scannerDeviceUrl'),
    source: formData.get('source'),
    duplex: document.getElementById('duplex').checked,
    swskip: parseFloat(formData.get('swskip')) || 0,
    pageWidth: parseInt(formData.get('pageWidth')) || 0,
    pageHeight: parseInt(formData.get('pageHeight')) || 0,
    outputFormat: formData.get('outputFormat'),
    defaultTags: defaultTags
  };

  try {
    const response = await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(settings)
    });

    const result = await response.json();
    
    if (response.ok) {
      showStatus("Settings saved successfully!", "success");
      currentSettings = settings;
    } else {
      showStatus(`Failed to save settings: ${result.error}`, "error");
    }
  } catch (error) {
    showStatus(`Network error: ${error.message}`, "error");
  }
};

// Test connection
testBtn.onclick = async () => {
  try {
    testBtn.disabled = true;
    testBtn.textContent = "‚è≥ Testing...";
    
    const response = await fetch("/test-connection", { method: "POST" });
    const result = await response.json();
    
    if (response.ok) {
      showStatus("Connection test successful!", "success");
    } else {
      showStatus(`Connection test failed: ${result.error}`, "error");
    }
  } catch (error) {
    showStatus(`Network error: ${error.message}`, "error");
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = "üîß Test Connection";
  }
};

// Reset settings
resetBtn.onclick = async () => {
  if (confirm("Are you sure you want to reset all settings to defaults? This cannot be undone.")) {
    try {
      const response = await fetch("/api/settings/reset", { method: "POST" });
      const result = await response.json();
      
      if (response.ok) {
        showStatus("Settings reset to defaults!", "success");
        await loadSettings(); // Reload the form
      } else {
        showStatus(`Failed to reset settings: ${result.error}`, "error");
      }
    } catch (error) {
      showStatus(`Network error: ${error.message}`, "error");
    }
  }
};

// File upload test functionality
testUploadInput.onchange = () => {
  uploadTestBtn.disabled = !testUploadInput.files || testUploadInput.files.length === 0;
};

uploadTestBtn.onclick = async () => {
  const file = testUploadInput.files?.[0];
  if (!file) {
    showStatus("Please select a file first", "error");
    return;
  }

  try {
    uploadTestBtn.disabled = true;
    uploadTestBtn.textContent = "‚è≥ Uploading...";
    
    const formData = new FormData();
    formData.append("document", file);
    
    // Add current default tags if any
    if (defaultTags && defaultTags.length > 0) {
      defaultTags.forEach(tag => {
        formData.append("tags", tag);
      });
    }
    
    const response = await fetch("/api/test-upload", {
      method: "POST",
      body: formData
    });

    const result = await response.json();
    
    if (response.ok) {
      showStatus(`Upload successful! ${result.message || 'File uploaded to Paperless-ngx'}`, "success");
      testUploadInput.value = ''; // Clear the file input
    } else {
      showStatus(`Upload failed: ${result.error}`, "error");
    }
  } catch (error) {
    showStatus(`Network error: ${error.message}`, "error");
  } finally {
    uploadTestBtn.disabled = true;
    uploadTestBtn.textContent = "üì§ Test Upload";
  }
};

// Add tag on Enter key
newTagInput.onkeypress = (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    addTag(newTagInput.value);
    newTagInput.value = '';
  }
};

// Load settings when page loads
// loadSettings(); // Handled by window.onload

// Make removeTag function global
window.removeTag = removeTag;
</script>
</body>
</html>